{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Messenger++</title>

    <!-- from external -->
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet prefetch"
      href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"
    />
    <link
      rel="stylesheet prefetch"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css"
    />

    <link rel="stylesheet" href="{% static 'css/css_main.css' %}" />
  </head>

  <body>
    <!-- 

A concept for a chat interface. 

Try writing a new message! :)


Follow me here:
Twitter: https://twitter.com/thatguyemil
Codepen: https://codepen.io/emilcarlsson/
Website: http://emilcarlsson.se/

-->

    <div id="frame">
      <div id="sidepanel">
        <div id="profile">
          <div class="wrap">
            {% if user.is_authenticated %}

            <img
              id="profile-img"
              src="https://ui-avatars.com/api/?background=random&size=720&name={{ user.first_name }}+{{ user.last_name }}"
              class="online"
              alt=""
            />
            <p>{{ user.first_name }} {{ user.last_name }}</p>

            {% else %}

            <img
              id="profile-img"
              src="https://ui-avatars.com/api/?background=random&size=720&name={{ user }}"
              class="online"
              alt=""
            />
            <p>{{ user }}</p>

            {% endif %}

            <i class="fa fa-chevron-down expand-button" aria-hidden="true"></i>
            <div id="status-options">
              <ul>
                <li id="status-online" class="active">
                  <span class="status-circle"></span>
                  <p>Online</p>
                </li>
                <li id="status-away">
                  <span class="status-circle"></span>
                  <p>Away</p>
                </li>
                <li id="status-busy">
                  <span class="status-circle"></span>
                  <p>Busy</p>
                </li>
                <li id="status-offline">
                  <span class="status-circle"></span>
                  <p>Offline</p>
                </li>
              </ul>
            </div>
            <div id="expanded">
              <label for="twitter"
                ><i class="fa fa-facebook fa-fw" aria-hidden="true"></i
              ></label>
              <input name="twitter" type="text" value="mikeross" />
              <label for="twitter"
                ><i class="fa fa-twitter fa-fw" aria-hidden="true"></i
              ></label>
              <input name="twitter" type="text" value="ross81" />
              <label for="twitter"
                ><i class="fa fa-instagram fa-fw" aria-hidden="true"></i
              ></label>
              <input name="twitter" type="text" value="mike.ross" />
            </div>
          </div>
        </div>
        <div id="search">
          <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
          <input type="text" placeholder="Search contacts..." />
        </div>
        <div id="contacts">
          <ul>
            <li class="contact">
              <div class="wrap">
                <span class="contact-status online"></span>
                <img
                  src="https://ui-avatars.com/api/?background=random&size=720&name=Louis+Litt"
                  alt=""
                />
                <div class="meta">
                  <p class="name">Louis Litt</p>
                  <p class="preview">You just got LITT up, Mike.</p>
                </div>
              </div>
            </li>
            <li class="contact active">
              <div class="wrap">
                <span class="contact-status busy"></span>
                <img
                  src="https://ui-avatars.com/api/?background=random&size=720&name=Halim+Vai"
                  alt=""
                />
                <div class="meta">
                  <p class="name">Harvey Specter</p>
                  <p class="preview">
                    Wrong. You take the gun, or you pull out a bigger one. Or,
                    you call their bluff. Or, you do any one of a hundred and
                    forty six other things.
                  </p>
                </div>
              </div>
            </li>
            <li class="contact">
              <div class="wrap">
                <span class="contact-status away"></span>
                <img
                  src="https://ui-avatars.com/api/?background=random&size=720&name=Rachel+Zane"
                  alt=""
                />
                <div class="meta">
                  <p class="name">Rachel Zane</p>
                  <p class="preview">
                    I was thinking that we could have chicken tonight, sounds
                    good?
                  </p>
                </div>
              </div>
            </li>
          </ul>
        </div>
        <div id="bottom-bar">
          <button id="addcontact">
            <i class="fa fa-user-plus fa-fw" aria-hidden="true"></i>
            <span>Add contact</span>
          </button>
          <button id="settings">
            <i class="fa fa-cog fa-fw" aria-hidden="true"></i>
            <span>Settings</span>
          </button>
        </div>
      </div>
      <div class="content">
        <div class="contact-profile">
          <img
            src="https://ui-avatars.com/api/?background=random&size=720&name=Halim+Vai"
            alt=""
          />
          <p>Harvey Specter .</p>
          <small id="screen">screen </small>

          <div class="social-media" hidden>
            <i class="fa fa-facebook" aria-hidden="true"></i>
            <i class="fa fa-twitter" aria-hidden="true"></i>
            <i class="fa fa-instagram" aria-hidden="true"></i>
          </div>
        </div>
        <div class="messages">
          <ul>
            <li class="replies">
              <img
                src="https://ui-avatars.com/api/?background=random&size=720&name=Harvey+Specter"
                alt=""
              />
              <p>
                Excuses don't win championships.<br />
                <small>12:10pm</small>
              </p>
            </li>
            <li class="sent">
              <img
                src="https://ui-avatars.com/api/?background=random&size=720&name=Halim+Vai"
                alt=""
              />
              <p>
                Oh yeah, did Michael Jordan tell you that?<br />
                <small>12:15pm</small>
              </p>
            </li>
            <li class="replies">
              <img
                src="https://ui-avatars.com/api/?background=random&size=720&name=Harvey+Specter"
                alt=""
              />
              <p>
                No, I told him that.<br />
                <small>12:20pm</small>
              </p>
            </li>
            <li class="sent">
              <img
                src="https://ui-avatars.com/api/?background=random&size=720&name=Halim+Vai"
                alt=""
              />
              <p>
                What are you talking about? You do what they say or they shoot
                you.
                <br />
                <small>12:25pm</small>
              </p>
            </li>
            <li class="replies" style="overflow-wrap: break-word">
              <img
                src="https://ui-avatars.com/api/?background=random&size=720&name=Harvey+Specter"
                alt=""
              />
              <p>
                aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                <br />
                <small>12:30pm</small>
              </p>
            </li>
          </ul>
          <div class="message-input">
            <div class="wrap">
              <input type="text" placeholder="Write your message..." />
              <i class="fa fa-paperclip attachment" aria-hidden="true"></i>
              <button class="submit">
                <i class="fa fa-paper-plane" aria-hidden="true"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="{% static 'js/reconnecting-websocket.js' %}"></script>
    <script>
      //   $(".messages").animate({ scrollTop: $(document).height() }, "fast");
      $("#screen").html($(window).width() + "and" + $(document).width());

      $("#profile-img").click(function () {
        $("#status-options").toggleClass("active");
      });

      $(".expand-button").click(function () {
        $("#profile").toggleClass("expanded");
        $("#contacts").toggleClass("expanded");
      });

      $("#status-options ul li").click(function () {
        $("#profile-img").removeClass();
        $("#status-online").removeClass("active");
        $("#status-away").removeClass("active");
        $("#status-busy").removeClass("active");
        $("#status-offline").removeClass("active");
        $(this).addClass("active");

        if ($("#status-online").hasClass("active")) {
          $("#profile-img").addClass("online");
        } else if ($("#status-away").hasClass("active")) {
          $("#profile-img").addClass("away");
        } else if ($("#status-busy").hasClass("active")) {
          $("#profile-img").addClass("busy");
        } else if ($("#status-offline").hasClass("active")) {
          $("#profile-img").addClass("offline");
        } else {
          $("#profile-img").removeClass();
        }

        $("#status-options").removeClass("active");
      });

      function findTime(timeStamp) {
        let timeSpend = new Date().getTime() - new Date(timeStamp).getTime(); //in milliseconds
        timeSpend = timeSpend / 1000; // ms to seconds

        let sendtime;
        if (timeSpend < 60) {
          sendtime = Math.ceil(timeSpend) + " seconds ago";
        } else if (timeSpend < 3600) {
          // less then 1 hour < 3600 s
          sendtime = Math.floor(timeSpend / 60) + " minutes ago";
        } else if (timeSpend < 46800) {
          // less then 13 hour < 46800 s
          sendtime = Math.floor(timeSpend / 3600) + " hours ago";
        } else if (timeSpend < 604800) {
          // less then 7 days < 604800 s
          sendtime = Math.floor(timeSpend / 86400) + " days ago";
        } else {
          sendtime =
            new Date(timeStamp).toLocaleTimeString() +
            "<br>" +
            new Date(timeStamp).toDateString();
          // '7:29:22 PM'
          // 'Fri Apr 01 2022'
        }
        return sendtime;
      }

      function printMessage(sender, message, sendTime = findTime(new Date())) {
        if ($.trim(message) == "") {
          return false;
        }

        let className = sender === "{{user}}" ? "sent" : "replies";
        // console.log("{{user}}")
        // console.log(className)

        $(
          "<li class=" +
            className +
            ' style="overflow-wrap: break-word">' +
            '<img src="https://ui-avatars.com/api/?background=random&size=720&name=' +
            sender +
            '" alt="" /><p>' +
            message +
            "<br> <small>" +
            sendTime +
            "</small></p></li>"
        ).appendTo($(".messages ul"));

        // $(".message-input input").val(null);
        $(".contact.active .preview").html("<span>You: </span>" + message);
        $(".messages").animate(
          {
            scrollTop:
              $(".messages").prop("scrollHeight") - $(".messages").height(),
          },
          0
        );
      }

      let roomName = "{{ room_name }}";
      // WebSocket connection
      let chatSocket;
      if (window.location.protocol == "https:") {
        // checks If HTTPs or not
        // chatSocket = new WebSocket(
        chatSocket = new ReconnectingWebSocket(
          "wss://" + window.location.host + "/ws/chat/" + roomName + "/"
        );
      } else {
        chatSocket = new ReconnectingWebSocket(
          "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
        );
      }

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        // console.log(e);
        // console.log(data);
        let sendtime = findTime(data.date);
        // console.log(sendtime);

        printMessage(data.sender, data.message, sendtime);
      };

      chatSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly");
        console.error(e.data);
      };

      function sendMessage() {
        sender = "{{user}}";
        message = $(".message-input input").val();
        if ($.trim(message) == "") {
          return false;
        }

        // printMessage(sender, message);
        $(".message-input input").val(null);

        // sending message into websocket
        chatSocket.send(
          JSON.stringify({
            sender: sender,
            message: message,
          })
        );

        // $(".messages").animate({ scrollTop: $(".messages").prop("scrollHeight") - $(".messages").height() }, "fast");
      }

      $(".submit").click(function () {
        sendMessage();
      });

      //   $(window).on("keydown", function (e) {
      $(".message-input").on("keyup", function (e) {
        if (e.which == 13) {
          sendMessage();
          return false;
        }
      });
    </script>
  </body>
</html>
